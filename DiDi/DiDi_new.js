/*
"Êª¥Êª¥Âá∫Ë°å" app Ëá™Âä®Á≠æÂà∞ÔºåÊîØÊåÅ Quantumult X„ÄÅSurge„ÄÅLoonÔºàÁêÜËÆ∫‰∏ä‰πüÊîØÊåÅ ShadowrocketÔºåÊú™Â∞ùËØïÔºâ„ÄÇ
ËØ∑ÂÖàÊåâ‰∏ãËø∞ÊñπÊ≥ïËøõË°åÈÖçÁΩÆÔºåËøõÂÖ•"Êª¥Êª¥Âá∫Ë°å"ÔºåËã•ÂºπÂá∫"È¶ñÊ¨°ÂÜôÂÖ•Êª¥Êª¥Âá∫Ë°å Token ÊàêÂäü"Âç≥ÂèØÊ≠£Â∏∏È£üÁî®ÔºåÂÖ∂‰ªñÊèêÁ§∫ÊàñÊó†ÊèêÁ§∫ËØ∑ÂèëÈÄÅÊó•Âøó‰ø°ÊÅØËá≥ issue„ÄÇ
Âà∞ cron ËÆæÂÆöÊó∂Èó¥Ëá™Âä®Á≠æÂà∞Êó∂ÔºåËã•ÂºπÂá∫"Êª¥Êª¥Âá∫Ë°å - Á≠æÂà∞ÊàêÂäü"Âç≥ÂÆåÊàêÁ≠æÂà∞ÔºåÂÖ∂‰ªñÊèêÁ§∫ÊàñÊó†ÊèêÁ§∫ËØ∑ÂèëÈÄÅÊó•Âøó‰ø°ÊÅØËá≥ issue„ÄÇ

‚ö†Ô∏èÂÖçË¥£Â£∞ÊòéÔºö
1. Ê≠§ËÑöÊú¨‰ªÖÁî®‰∫éÂ≠¶‰π†Á†îÁ©∂Ôºå‰∏ç‰øùËØÅÂÖ∂ÂêàÊ≥ïÊÄß„ÄÅÂáÜÁ°ÆÊÄß„ÄÅÊúâÊïàÊÄßÔºåËØ∑Ê†πÊçÆÊÉÖÂÜµËá™Ë°åÂà§Êñ≠ÔºåÊú¨‰∫∫ÂØπÊ≠§‰∏çÊâøÊãÖ‰ªª‰Ωï‰øùËØÅË¥£‰ªª„ÄÇ
2. Áî±‰∫éÊ≠§ËÑöÊú¨‰ªÖÁî®‰∫éÂ≠¶‰π†Á†îÁ©∂ÔºåÊÇ®ÂøÖÈ°ªÂú®‰∏ãËΩΩÂêé 24 Â∞èÊó∂ÂÜÖÂ∞ÜÊâÄÊúâÂÜÖÂÆπ‰ªéÊÇ®ÁöÑËÆ°ÁÆóÊú∫ÊàñÊâãÊú∫Êàñ‰ªª‰ΩïÂ≠òÂÇ®ËÆæÂ§á‰∏≠ÂÆåÂÖ®Âà†Èô§ÔºåËã•ËøùÂèçËßÑÂÆöÂºïËµ∑‰ªª‰Ωï‰∫ã‰ª∂Êú¨‰∫∫ÂØπÊ≠§Âùá‰∏çË¥üË¥£„ÄÇ
3. ËØ∑ÂãøÂ∞ÜÊ≠§ËÑöÊú¨Áî®‰∫é‰ªª‰ΩïÂïÜ‰∏öÊàñÈùûÊ≥ïÁõÆÁöÑÔºåËã•ËøùÂèçËßÑÂÆöËØ∑Ëá™Ë°åÂØπÊ≠§Ë¥üË¥£„ÄÇ
4. Ê≠§ËÑöÊú¨Ê∂âÂèäÂ∫îÁî®‰∏éÊú¨‰∫∫Êó†ÂÖ≥ÔºåÊú¨‰∫∫ÂØπÂõ†Ê≠§ÂºïËµ∑ÁöÑ‰ªª‰ΩïÈöêÁßÅÊ≥ÑÊºèÊàñÂÖ∂‰ªñÂêéÊûú‰∏çÊâøÊãÖ‰ªª‰ΩïË¥£‰ªª„ÄÇ
5. Êú¨‰∫∫ÂØπ‰ªª‰ΩïËÑöÊú¨ÂºïÂèëÁöÑÈóÆÈ¢òÊ¶Ç‰∏çË¥üË¥£ÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫éÁî±ËÑöÊú¨ÈîôËØØÂºïËµ∑ÁöÑ‰ªª‰ΩïÊçüÂ§±ÂíåÊçüÂÆ≥„ÄÇ
6. Â¶ÇÊûú‰ªª‰ΩïÂçï‰ΩçÊàñ‰∏™‰∫∫ËÆ§‰∏∫Ê≠§ËÑöÊú¨ÂèØËÉΩÊ∂âÂ´å‰æµÁäØÂÖ∂ÊùÉÂà©ÔºåÂ∫îÂèäÊó∂ÈÄöÁü•Âπ∂Êèê‰æõË∫´‰ªΩËØÅÊòéÔºåÊâÄÊúâÊùÉËØÅÊòéÔºåÊàë‰ª¨Â∞ÜÂú®Êî∂Âà∞ËÆ§ËØÅÊñá‰ª∂Á°ÆËÆ§ÂêéÂà†Èô§Ê≠§ËÑöÊú¨„ÄÇ
7. ÊâÄÊúâÁõ¥Êé•ÊàñÈó¥Êé•‰ΩøÁî®„ÄÅÊü•ÁúãÊ≠§ËÑöÊú¨ÁöÑ‰∫∫ÂùáÂ∫îËØ•‰ªîÁªÜÈòÖËØªÊ≠§Â£∞Êòé„ÄÇÊú¨‰∫∫‰øùÁïôÈöèÊó∂Êõ¥ÊîπÊàñË°•ÂÖÖÊ≠§Â£∞ÊòéÁöÑÊùÉÂà©„ÄÇ‰∏ÄÊó¶ÊÇ®‰ΩøÁî®ÊàñÂ§çÂà∂‰∫ÜÊ≠§ËÑöÊú¨ÔºåÂç≥ËßÜ‰∏∫ÊÇ®Â∑≤Êé•ÂèóÊ≠§ÂÖçË¥£Â£∞Êòé„ÄÇ

AuthorÔºözZPiglet

----------
ÁâàÊú¨ËÆ∞ÂΩïÔºö
- 2021 / 02 / 26
Â¢ûÂä†‚ÄúËµ∞Ë∑ØËµöÈí±‚Äù‰∏≠‚ÄúÂ§©Â§©Ê≠•Êï∞Ëµõ‚ÄùÊ¥ªÂä®ÔºåÂπ∂Â∞Ü‚ÄúËµ∞Ë∑ØËµöÈí±‚ÄùÁ≥ªÂàóÁßªËá≥ 20:01 ‰πãÂêéÊâÄÊúâÊó∂Èó¥ËøêË°åÊúâÊïàÔºå‰∏îËøôÊÆµÊó∂Èó¥‰∏çÂÜçÊâßË°å‰∏ª‰ªªÂä°„ÄÇ  
Ê≥®Ôºö20:00 Êó∂ÊÆµ‰øùÁïôÔºåÊª¥Êª¥ÊúâÂèØËÉΩËøò‰ºöÂèëÊôöÂÖ´ÁÇπ‰ºòÊÉ†Âà∏„ÄÇ
- 2021 / 01 / 30  
Â¢ûÂä†‚ÄúËµ∞Ë∑ØËµöÈí±‚ÄùÊ¥ªÂä®ÔºåÈôêÊôöÂÖ´ÁÇπËøêË°å„ÄÇ
- 2020 / 11 / 24  
Â¢ûÂä†‰ªéÂ∞èÁ®ãÂ∫èËé∑Âèñ TokenÔºå‰ªé App ÊàñÂ∞èÁ®ãÂ∫èËé∑Âèñ‰ªªÈÄâ‰∏Ä‰∏™Âç≥ÂèØ„ÄÇ
- 2020 / 11 / 23  
ÊµãËØïÈò∂ÊÆµÔºåÂèØËÉΩ‰ºöÂá∫Áé∞ÂêÑÁßçÈóÆÈ¢òÔºåÂ∏åÊúõÂõ†ËÑöÊú¨Âá∫Áé∞ÈóÆÈ¢òÂèØÂèäÊó∂ÂèçÈ¶à„ÄÇ
Ëã•‰ΩøÁî®Ê≠§ËÑöÊú¨ÂàôÂèØ‰ª•ÂéªÊéâÂéüÊúâÁöÑÊª¥Êª¥Áõ∏ÂÖ≥ÊâÄÊúâËÑöÊú¨ÔºåÊ≠§ËÑöÊú¨‰∏∫Êï¥ÂêàÈõÜÔºå‰ª•Âêé‰πüÂè™Êõ¥Êñ∞Ê≠§ËÑöÊú¨„ÄÇ
aff ÈªòËÆ§ÂºÄÂêØÔºåÂèØÂú® BoxJs ‰∏≠ÂÖ≥Èó≠ÔºåÂ¶ÇÂÖ≥Èó≠ affÔºåÂ∞ÜÊó†Ê≥ï‰ΩøÁî®‰∏Ä‰∫õÂÖ≥‰∫éÊäΩÂ•ñ„ÄÅÊª¥Êª¥ÈáëËûçÁ≠â‰πãÁ±ªÁöÑÂäüËÉΩÔºåÂõ†‰∏∫Ëøô‰∫õÂäüËÉΩÈúÄË¶ÅÊåÅÁª≠Áª¥Êä§Ê¥ªÂä®ÁºñÂè∑„ÄÇ
Ëã•Â∏åÊúõ‰ΩøÁî®ÂÖ≥‰∫é‚ÄúÊª¥Êª¥ÈáëËûç‚ÄùÊñπÈù¢ÁöÑÁ≠æÂà∞ÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØÔºåÊ≠§ÂäüËÉΩÈªòËÆ§ÂÖ≥Èó≠„ÄÇ
Áõ∏ÂØπ‰πãÂâçÁöÑËÑöÊú¨ÔºåÊ≠§ËÑöÊú¨Êï¥ÂêàËøõ‰∫ÜÁ¶èÂà©ÈáëÁ≠æÂà∞„ÄÅÈÅóÂøòÁöÑÁ¶èÂà©ÈáëÈ¢ÜÂèñ„ÄÅÈÅóÂøòÁöÑÁßØÂàÜÈ¢ÜÂèñ„ÄÅÁ®≥ËµöÁöÑÊäΩÂ•ñ„ÄÅÈáëËûçÁ≠æÂà∞‰ª•ÂèäÊä¢Âà∏ÔºàÊ≠§ÂäüËÉΩÁõÆÂâçÂè™ÂÜôÂÖ•‰∫ÜÊôöÂÖ´ÁÇπÁöÑÂà∏ÔºåÂ¶ÇÈúÄ‰ΩøÁî®ËØ∑‰øùËØÅ cron Âê´ÊúâÊôöÂÖ´ÁÇπÔºâ„ÄÇ
Áî±‰∫é iOS 14 ÈÄöÁü•Â≠óÊï∞ÁöÑÈôêÂà∂ÔºåÈÄöÁü•ÂèØËÉΩ‰∏çÂÆåÂÖ®ÔºàÂ∞§ÂÖ∂ÊòØÂá∫Ë°åÂ∑≤ÁúÅ„ÄÅÁé∞ÊúâÈÉ®ÂàÜ‰ºòÊÉ†Âà∏ÂèäÁ¶èÂà©Èáë‰ºòÊÉ†Âà∏Âç≥Â∞ÜËøáÊúüÁöÑ‰ø°ÊÅØÔºâÔºåËØ∑Âú®Êó•Âøó‰∏≠Êü•ÁúãÂÆåÊï¥‰ø°ÊÅØ„ÄÇ
Â∏∏ËßÅÈîôËØØÔºö
1. Ëã•ÊòØ Token Ëé∑ÂèñÈóÆÈ¢òËØ∑ÂÖàËá™Ë°åÊéíÊü•ÈáçÂÜôÂèä‰∏ªÊú∫ÂêçÊòØÂê¶Ê≠£Á°ÆÔºåËã•ÂùáÊ≠£Á°Æ‰∏îÊó•ÂøóÊó†Êä•ÈîôÁöÑÊÉÖÂÜµ‰∏ãÊó†Ê≥ïËé∑ÂèñÔºåËØ∑ÂèçÈ¶àÔºåÂπ∂ÊúÄÂ•ΩËÉΩÊèê‰æõÊäìÂåÖËÆ∞ÂΩïÔºàÊâìÂºÄÊäìÂåÖËΩØ‰ª∂ÔºåÁÑ∂ÂêéÂÜçËøõÂÖ•Êª¥Êª¥ÔºåËøõÂÖ•ÊâìËΩ¶ÁöÑÁïåÈù¢‰πãÂêéÂÖ≥Èó≠ÊäìÂåÖÁöÑËΩØ‰ª∂ÔºåÂØºÂá∫Ëøô‰∏™ÂåÖÁßÅÂèëÁªôÊàëÂ∞±Ë°åÔºâ„ÄÇ
----------

Quantumult X:
[task_local]
0 1,20,21 * * * https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js, tag=Êª¥Êª¥Âá∫Ë°å
[rewrite_local]
# APP
^https:\/\/as\.xiaojukeji\.com\/ep\/as\/toggles\? url script-request-header https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js
# MiniApp
^https:\/\/common\.diditaxi\.com\.cn\/webapp\/config\/sidebar\? url script-request-header https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js

Surge:
[Script]
Êª¥Êª¥Âá∫Ë°å = type=cron,cronexp="0 1,20,21 * * *",wake-system=1,script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js
Êª¥Êª¥Âá∫Ë°åAPPCookie = type=http-request,pattern=^https:\/\/as\.xiaojukeji\.com\/ep\/as\/toggles\?,script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js
Êª¥Êª¥Âá∫Ë°åÂ∞èÁ®ãÂ∫èCookie = type=http-request,pattern=^https:\/\/common\.diditaxi\.com\.cn\/webapp\/config\/sidebar\?,script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js

Loon„ÄÅShadowrocket:
[Script]
cron "0 1,20,21 * * *" script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js
# APP
http-request ^https:\/\/as\.xiaojukeji\.com\/ep\/as\/toggles\? script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js
# WeChat-MiniApp
http-request ^https:\/\/common\.diditaxi\.com\.cn\/webapp\/config\/sidebar\? script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/DiDi/DiDi_new.js

All app:
[mitm]
hostname = as.xiaojukeji.com, common.diditaxi.com.cn // ÂâçËÄÖ‰∏∫ App Ëé∑ÂèñÔºåÊàñËÄÖ‰∏∫ÂæÆ‰ø°Â∞èÁ®ãÂ∫èËé∑Âèñ

Ëé∑ÂèñÂÆå Token ÂêéÂèØ‰∏çÊ≥®Èáä rewrite / hostnameÔºåToken Êõ¥Êñ∞Êó∂‰ºöÂºπÁ™ó„ÄÇËã•Âõ† MitM ÂØºËá¥ËØ•ËΩØ‰ª∂ÊàñÂ∞èÁ®ãÂ∫èÁΩëÁªú‰∏çÁ®≥ÂÆöÔºåÂèØÊ≥®ÈáäÊéâ hostname„ÄÇ
*/

const $ = API("Didi");
$.debug = [true, "true"].includes($.read("debug"));
const ERR = MYERR();
$.subTitle = "";
$.detail = "";
$.drawgifts = "";
$.couponids = "";
$.tail = "";
$.expire = "";
$.times = {};
const mainURL = "https://bosp-api.xiaojukeji.com";
const awardURL = "https://api.udache.com/gulfstream/passenger/v2/other";
const financeURL =
	"https://manhattan.webapp.xiaojukeji.com/marvel/api/manhattan-signin-task/signIn";
const pointURL = "https://quartz.xiaojukeji.com/volcano/quartz";
const signgiftURL = "https://gsh5act.xiaojukeji.com/dpub_data_api/activities";
const busURL = "https://market.bus.xiaojukeji.com/api/transit";
const stepURL = "https://sigma.xiaojukeji.com/api";
const treeURL = "https://tree.xiaojukeji.com:9443";
let noaff = $.read("noaff");
const aff = noaff == undefined ? true : ![true, "true"].includes(noaff);
const today =
	new Date().getFullYear() +
	"-" +
	("00" + Number(new Date().getMonth() + 1)).substr(-2) +
	"-" +
	("00" + new Date().getDate()).substr(-2);
const NINE_O_CLOCK_AM = new Date(
	new Date().toString().replace(/\d{2}:\d{2}:\d{2}/, "09:00:00")
).getTime();
const EIGHT_O_CLOCK_PM = new Date(
	new Date().toString().replace(/\d{2}:\d{2}:\d{2}/, "20:00:00")
).getTime();
const delay = Number($.read("drawdelay") || 2000);

$.isFinance = [true, "true"].includes($.read("isFinance"));
$.isExpenddrawlids = [true, "true"].includes($.read("isExpenddrawlids"));

if ($.isRequest) {
	getToken();
	$.done({});
} else {
	!(async () => {
		$.Ticket = $.read("#DiDi");
		$.city = $.read("#DiDi_city");
		$.now = new Date().getTime();
		if (!$.Ticket || !$.city) {
			throw new ERR.TokenError("‚ùå Êú™Ëé∑ÂèñÊàñÂ°´ÂÜô Token");
		} else {
			if ($.now >= EIGHT_O_CLOCK_PM - 10 * 1000 && $.now < EIGHT_O_CLOCK_PM + 60 * 1000) {
				$.pmids = isJSON($.read("actIdPM"));
				if ($.pmids && $.pmids.length) {
					await Promise.all(
						$.pmids.map(async (id) => {
							await grabCoupons(id);
						})
					);
					await $.info("Êª¥Êª¥Âá∫Ë°å\n" + $.subTitle + "\n" + $.detail);
					await $.notify("Êª¥Êª¥Âá∫Ë°å üöï", $.subTitle, $.detail);
				}
				/*
				if (aff) await getIds();
				await getIds();
				if ($.activity_instance_id && Math.random() < $.probability) {
					await instance();
				}
				*/
			} else if ($.now >= EIGHT_O_CLOCK_PM + 60 * 1000) {
				if (aff) await getIds();
				await steps();
				await $.info("Êª¥Êª¥Ëµ∞Ë∑Ø\n" + $.subTitle + "\n" + $.detail);
				await $.notify("Êª¥Êª¥Ëµ∞Ë∑Ø ‚ôøÔ∏è", $.subTitle, $.detail);
			} else {
				/* 
			else if ($.now >= NINE_O_CLOCK_AM - 2 * 1000 && $.now <= NINE_O_CLOCK_AM + 60 * 1000) {
				$.amids = isJSON($.read("actIdAM"));
				if ($.amids && $.amids.length) {
					await Promise.all(
						$.amids.map(async (id) => {
							await grabCoupons(id);
						})
					);
					await $.info("Êª¥Êª¥Âá∫Ë°å\n" + $.subTitle + "\n" + $.detail);
					await $.notify("Êª¥Êª¥Âá∫Ë°å üöï", $.subTitle, $.detail);
				}
				await getIds();
				//await tree();
				if ($.activity_instance_id && Math.random() < $.probability) {
					await instance();
				}
			}  
			*/
				if (aff) await getIds();
				$.checkinParams = "&city_id=" + $.city;
				if ($.source_id) {
					let s_i = await Choose($.source_id);
					$.checkinParams += "&share_source_id=" + s_i + "&share_date=" + today;
				}
				await checkin();
				await storeActId();
				await reward();
				if ($.drawlids) {
					await Promise.all(
						$.drawlids.map(async (lid) => {
							$.times[lid] = 1;
							while ($.times[lid]) {
								await draw(lid);
								await drawShare(lid);
							}
						})
					);
				}
				if ($.isExpenddrawlids && $.expenddrawlids) {
					await Promise.all(
						$.expenddrawlids.map(async (lid) => {
							$.times[lid] = 1;
							while ($.times[lid]) {
								await draw(lid);
								await drawShare(lid);
							}
						})
					);
				}
				await pointCollect();
				await pointSign();
				await pointInfo();
				//await lucina();
				//await didibus();
				/*
				if ($.activity_instance_id && Math.random() < $.probability) {
					await instance();
				}
				*/
				if ($.isFinance && $.financeActId) {
					await finance();
					while ($.fbroken) {
						await restartFinace();
						await finance();
					}
				}
				await $.info(
					"Êª¥Êª¥Âá∫Ë°å\n" +
						$.subTitle +
						"\n" +
						$.detail +
						$.couponids +
						$.drawgifts +
						$.tail +
						$.expire
				);
				await $.notify(
					"Êª¥Êª¥Âá∫Ë°å üöï",
					$.subTitle,
					$.detail + $.couponids + $.drawgifts + $.tail + $.expire
				);
			}
		}
	})()
		.catch((err) => {
			if (err instanceof ERR.TokenError) {
				$.notify("Êª¥Êª¥Âá∫Ë°å - Token ÈîôËØØ", "", err.message, "OneTravel://");
			} else if (err instanceof ERR.BodyError) {
				$.notify("Êª¥Êª¥Âá∫Ë°å - ËøîÂõûÈîôËØØ", "", err.message);
			} else {
				$.notify(
					"Êª¥Êª¥Âá∫Ë°å - Âá∫Áé∞ÈîôËØØ",
					"",
					JSON.stringify(err, Object.getOwnPropertyNames(err))
				);
				$.error(JSON.stringify(err, Object.getOwnPropertyNames(err)));
			}
		})
		.finally(() => $.done());
}

function Choose(v) {
	let r = Math.floor(Math.random() * v.length);
	return v[r];
}

function getIds() {
	return $.get({
		url:
			"https://gist.githubusercontent.com/zZPiglet/a9a537190bc6353923191520cf9a2c89/raw/DiDi.json",
	})
		.then((resp) => {
			$.log("getIds: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			$.sparePointSignURL = obj.sparePointSignURL;
			$.probability = obj.p;
			$.source_id = obj.source_id;
			let other_source_id = obj.other_source_id;
			$.source_id.push(Choose(other_source_id));
			$.step_share_source_id = obj.step_share_source_id;
			$.drawlids = obj.drawlids;
			$.expenddrawlids = obj.expenddrawlids;
			$.financeActId = obj.financeActId;
			//$.instanceScene = obj.instanceScene;
			//$.activity_instance_id = [];
			//$.activity_instance_id.push(obj.activity_instance_id1);
			//$.activity_instance_id.push(obj.activity_instance_id2);
		})
		.catch((err) => {
			throw err;
		});
}

function checkin() {
	return $.get({
		url: mainURL + "/wechat/benefit/public/index?" + $.checkinParams,
		headers: {
			"Didi-Ticket": $.Ticket,
		},
	})
		.delay(500)
		.then((resp) => {
			if (resp.statusCode == 403) {
				throw new ERR.TokenError("Token Â§±Êïà");
			} else {
				$.log("benefit: " + JSON.stringify(resp.body));
				let obj = isJSON(resp.body);
				if (obj && obj.errno == 0) {
					if (obj.data.sign.sign) {
						$.subTitle += "Á¶èÂà©ÈáëüÜó";
						let todayearn = Number(
							obj.data.sign.sign.subsidy_state.subsidy_amount +
								obj.data.sign.sign.subsidy_state.extra_subsidy_amount
						);
						$.detail += "Á≠æÂà∞Ëé∑Âæó " + todayearn + " Á¶èÂà©ÈáëÔºå";
					} else {
						$.subTitle += "Á¶èÂà©ÈáëüîÑ";
					}
					let total = Number(obj.data.welfare.carousel_text[0].slice(4));
					$.detail += "Ë¥¶Êà∑ÂÖ±Êúâ " + total + " Á¶èÂà©ÈáëÔºåÂèØÊäµÊâ£ " + total / 100 + " ÂÖÉ„ÄÇ";
					//if (obj.data.message && obj.data.message.text) $.info(obj.data.message.text);
					if (obj.data.notification) {
						for (let message of obj.data.notification.reverse()) {
							$.expire += "\n" + message;
						}
					}
				} else if (obj && obj.errno == 101) {
					throw new ERR.TokenError("Á≠æÂà∞Â§±Ë¥•‚ÄºÔ∏è ÂüéÂ∏Ç‰ª£Á†ÅÈîôËØØ„ÄÇ");
				} else {
					$.error(resp.body);
					throw new ERR.BodyError(
						"Ê¥ªÂä®È°µËøîÂõûÈîôËØØÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØË∞ÉËØïÊ®°ÂºèËøêË°åÂêéÂèçÈ¶àÊó•Âøó„ÄÇ\n" +
							JSON.stringify(resp.body)
					);
				}
			}
		})
		.catch((err) => {
			throw err;
		});
}

function storeActId() {
	return $.get({
		url:
			mainURL +
			"/wechat/benefit/public/v2/index?%7B%22resource_name%22:%22welfare_through_train_calendar%22%7D" +
			$.checkinParams,
		headers: {
			"Didi-Ticket": $.Ticket,
		},
	})
		.then((resp) => {
			$.log("storeActId: " + JSON.stringify(resp.body));
			let obj = isJSON(resp.body);
			$.delete("actIdAM");
			$.delete("actIdPM");
			if (obj && (obj.errno == 0 || obj.errno == 500)) {
				let actIdAM = [];
				let actIdPM = [];
				for (let a of obj.data.calendar[today]) {
					if (a.act_conf.receive_start_at) {
						if (a.act_conf.receive_start_at.match("09:00:00")) {
							actIdAM.push(a.act_id);
							$.info(a.act_conf.receive_start_at + ": " + a.act_id + " Â∑≤Â≠ò ‚úÖ");
							//$.detail += "\nÂà∏ÁºñÂè∑Ôºö" + a.act_conf.receive_start_at + ": " + a.act_id;
							//$.couponids += " Â∑≤Â≠ò ‚úÖ";
						} else if (a.act_conf.receive_start_at.match("20:00:00")) {
							actIdPM.push(a.act_id);
							$.info(a.act_conf.receive_start_at + ": " + a.act_id + " Â∑≤Â≠ò ‚úÖ");
							$.couponids +=
								"\nÂà∏ÁºñÂè∑Ôºö" + a.act_conf.receive_start_at + ": " + a.act_id;
							$.couponids += " Â∑≤Â≠ò ‚úÖ";
						} else {
							$.info(a.act_conf.receive_start_at + ": " + a.act_id + " Êú™Â≠ò ‚ùå");
							//$.couponids += "\nÂà∏ÁºñÂè∑Ôºö" + a.act_conf.receive_start_at + ": " + a.act_id;
							//$.couponids += " Êú™Â≠ò ‚ùå";
						}
					}
				}
				//if (obj.data.message && obj.data.message.text) $.info(obj.data.message.text);
				$.write(JSON.stringify(actIdAM), "actIdAM");
				$.write(JSON.stringify(actIdPM), "actIdPM");
				$.tail +=
					"\n\n" +
					obj.data.greeting.text.substr(3) +
					"ÔºåÁé∞Êúâ" +
					obj.data.coupon.carousel_text[0].slice(0, -1) +
					" Âº†";
				if (obj.data.coupon.carousel_text.length == 1) {
					$.tail += "„ÄÇ";
				} else {
					$.tail += "ÔºåÂê´Ôºö";
					for (let i = 1; i < obj.data.coupon.carousel_text.length; i++) {
						$.tail += obj.data.coupon.carousel_text[i].substr(1) + "„ÄÅ";
					}
					$.tail += "...";
				}
				$.info("DiDi source_id : \n" + obj.data.share.source_id);
				$.info("DiDi new_source_id : \n" + obj.data.share.new_source_id);
			} else {
				$.error(resp.body);
				throw new ERR.BodyError(
					"Êü•ËØ¢‰ºòÊÉ†Âà∏ËøîÂõûÈîôËØØÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØË∞ÉËØïÊ®°ÂºèËøêË°åÂêéÂèçÈ¶àÊó•Âøó„ÄÇ\n" +
						JSON.stringify(resp.body)
				);
			}
		})
		.catch((err) => {
			throw err;
		});
}

function pointCollect() {
	return $.post({
		url: pointURL + "/points/collect",
		headers: {
			"Content-Type": "application/x-www-form-urlencoded",
		},
		body: "app_id=common&token=" + encodeURIComponent($.Ticket),
	})
		.then((resp) => {
			$.log("pointCollect: " + JSON.stringify(resp.body));
		})
		.catch((err) => {
			$.error(err);
		});
}

async function pointSign() {
	await getPointSignURL();
	await prePointSign();
	if ($.pointSignWrongURL) {
		$.realPointSignURL = $.sparePointSignURL;
		await prePointSign();
	}
	if ($.pointSignActivityId) {
		await getPointSignDay();
		await doPointSign();
		if ($.canRewardPointSign) await rewardPointSign();
	}
}

function getPointSignURL() {
	return $.post({
		url: "https://res.xiaojukeji.com/resapi/activity/getMulti",
		headers: {
			"Content-Type": "application/x-www-form-urlencoded",
		},
		body: "resource_name=dcoin_mall_carousel",
	})
		.then((resp) => {
			$.log("getPointSignURL: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			let list = obj.data.dcoin_mall_carousel["256"].data;
			$.pointSignURL = "";
			for (let i = 0; i < list.length; i++) {
				if (list[i].timesegs[0].end_time - list[i].timesegs[0].start_time == 604799)
					$.pointSignURL = list[i].link;
			}
			$.realPointSignURL = $.pointSignURL ? $.pointSignURL : $.sparePointSignURL;
		})
		.catch((err) => {
			throw err;
		});
}

function prePointSign() {
	return $.get({
		url: $.realPointSignURL,
	})
		.then((resp) => {
			$.log("prePointSign: " + resp.body);
			let resphtml = resp.body;
			let exec = /window.scenes = \[(\{.*\})\]/.exec(resphtml);
			if (exec) {
				let signobj = JSON.parse(exec[1]);
				let obj = signobj.layers[0].activityConfig;
				$.pointSignActivityId = obj.activity_id;
				$.signPointIds = obj.config.daily_prize;
				$.pointSignDayMax = obj.config.signin_days;
			} else {
				$.pointSignWrongURL = true;
			}
		})
		.catch((err) => {
			throw err;
		});
}

function getPointSignDay() {
	return $.get({
		url:
			signgiftURL +
			"/" +
			$.pointSignActivityId +
			"/signin?signin_user_token=" +
			encodeURIComponent($.Ticket),
	})
		.then((resp) => {
			$.log("getPointSignDay: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			$.pointSignDay =
				obj.signins.length + 1 > $.pointSignDayMax
					? $.pointSignDayMax
					: obj.signins.length + 1;
		})
		.catch((err) => {
			throw err;
		});
}

function doPointSign() {
	return $.post({
		url: signgiftURL + "/" + $.pointSignActivityId + "/signin",
		headers: {
			"Content-Type": "application/json; charset=utf-8",
		},
		body:
			'{"signin_day":' +
			$.pointSignDay +
			',"signin_type":0,"signin_user_token":"' +
			$.Ticket +
			'"}',
	})
		.then((resp) => {
			$.log("doPointSign: " + JSON.stringify(resp.body));
			$.canRewardPointSign = true;
		})
		.catch((err) => {
			throw err;
		});
}

function rewardPointSign() {
	return $.post({
		url: signgiftURL + "/" + $.pointSignActivityId + "/reward_lottery",
		headers: {
			"Content-Type": "application/json; charset=utf-8",
		},
		body:
			'{"user_token":"' +
			$.Ticket +
			'","signin_day":' +
			$.pointSignDay +
			',"lottery_id":"' +
			$.signPointIds[$.pointSignDay - 1].prize_id +
			'"}',
	})
		.then((resp) => {
			$.log("rewardPointSign: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.subTitle += " ÁßØÂàÜüÜó";
				let todayearn = obj.lottery.prize.name.slice(0, -2);
				//let total = obj.lottery.userinfo.current_point;
				$.detail += "\nÁ≠æÂà∞Ëé∑Âæó " + todayearn + " ÁßØÂàÜÔºå"; //"Ë¥¶Êà∑ÂÖ±Êúâ " + total + " ÁßØÂàÜ„ÄÇ";
			} else if (obj.errno == 1) {
				$.subTitle += " ÁßØÂàÜüîÑ";
			}
		})
		.catch((err) => {
			throw err;
		});
}

function pointInfo() {
	return $.get({
		url: pointURL + "/user/account?source_id=ckjf_10001&token=" + encodeURIComponent($.Ticket),
	})
		.then((resp) => {
			$.log("pointInfo: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			let total = obj.data.dcoin.coin;
			let expirepoint = obj.data.dcoin.expire_balance;
			let expiredate = obj.data.dcoin.expire_date;
			$.detail += "Ë¥¶Êà∑ÂÖ±Êúâ " + total + " ÁßØÂàÜ";
			$.detail +=
				expiredate && expirepoint
					? "ÔºåÊúâ " + expirepoint + " ÁßØÂàÜÂ∞ÜÂú® " + expiredate + " ËøáÊúü„ÄÇ"
					: "„ÄÇ";
		})
		.catch((err) => {
			$.error(err);
		});
}

async function reward() {
	$.rewardtotal = 0;
	await rewardList();
	if ($.rewardList) await getReward();
	if ($.rewardtotal) $.detail += "Êç°ÂõûÈÅóÂøòÁöÑ " + $.rewardtotal.toFixed(2) + " ÂÖÉÁ¶èÂà©Èáë„ÄÇ";
}

function rewardList() {
	return $.get({
		url: awardURL + "/pListReward?token=" + encodeURIComponent($.Ticket),
	})
		.then((resp) => {
			$.log("rewardList: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				if (obj.data) {
					$.rewardList = obj.data;
				}
			} else {
				$.error(resp.body);
				throw new ERR.BodyError(
					"ÊâìËΩ¶ÂêéÊú™È¢ÜÁ¶èÂà©ÈáëÂàóË°®ËøîÂõûÈîôËØØÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØË∞ÉËØïÊ®°ÂºèËøêË°åÂêéÂèçÈ¶àÊó•Âøó„ÄÇ\n" +
						obj.errmsg
				);
			}
		})
		.catch((err) => {
			throw err;
		});
}

async function getReward() {
	for (let l of $.rewardList) {
		await $.get({
			url:
				awardURL +
				"/pGetRewards?order_id=" +
				l.oid +
				"&token=" +
				encodeURIComponent($.Ticket),
		})
			.then((resp) => {
				$.log("reward: " + JSON.stringify(resp.body));
				let obj = JSON.parse(resp.body);
				if (obj.errno == 0) {
					$.rewardtotal += Number(obj.data.bonus_info.amount);
				} else {
					$.error(resp.body);
					throw new ERR.BodyError(
						"ÊâìËΩ¶ÂêéÊú™È¢ÜÁ¶èÂà©ÈáëÈ¢ÜÂèñËøîÂõûÈîôËØØÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØË∞ÉËØïÊ®°ÂºèËøêË°åÂêéÂèçÈ¶àÊó•Âøó„ÄÇ\n" +
							obj.errmsg
					);
				}
			})
			.catch((err) => {
				throw err;
			});
	}
}

function draw(lid) {
	return $.get({
		url:
			mainURL +
			"/bosp-api/lottery/draw?lid=" +
			lid +
			"&token=" +
			encodeURIComponent($.Ticket),
	})
		.delay(delay)
		.then((resp) => {
			$.log(lid + " draw: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.code == 0) {
				$.drawgifts += "\n" + obj.data.prize.name + "Ôºö" + obj.data.prize.win_content;
				$.times[lid] = obj.data.userinfo.draw_times;
			} else {
				$.times[lid] = 0;
				$.info(lid + ": " + obj.message);
			}
		})
		.catch((err) => {
			$.error("draw " + lid + ": \n");
			$.error(err);
		});
}

function drawShare(lid) {
	return $.get({
		url:
			mainURL +
			"/bosp-api/lottery/incrDpubShareParticipateLimit?lid=" +
			lid +
			"&token=" +
			encodeURIComponent($.Ticket) +
			"&role=1",
	})
		.delay(delay)
		.then((resp) => {
			$.log(lid + " drawShare: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			$.times[lid] += obj.data.incr_num;
		})
		.catch((err) => {
			$.error("drawShare " + lid + ": \n");
			$.error(err);
		});
}

function finance() {
	return $.post({
		url: financeURL + "/execute",
		headers: {
			"Content-Type": "application/json",
		},
		body: '{"token":"' + $.Ticket + '","activityId":"' + $.financeActId + '","clientId":1}',
	})
		.then((resp) => {
			$.log("execute: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			$.fbroken = false;
			if (obj.errorCode == 0) {
				let serialTimes = obj.data.serialSignInTimes;
				let period = obj.data.periodDays;
				$.subTitle += " ÈáëËûç [" + serialTimes + "/" + period + "] Â§©";
				$.detail += "\nÈáëËûçÁ≠æÂà∞Ëé∑ÂæóÂ¶Ç‰∏ãÂ•ñÂìÅÔºö";
				for (let l of obj.data.giftDetail) {
					$.detail +=
						"\n" +
						l.displayJson.displayName +
						"Ôºö" +
						l.displayValue +
						" " +
						l.displayUnit +
						"Ôºå" +
						l.displayJson.displayDesc +
						"„ÄÇ";
				}
			} else if (obj.errorCode == 500000) {
				if (obj.errorMsg == "‰ªäÂ§©Â∑≤ÁªèÁ≠æÂà∞Ëøá‰∫Ü") {
					$.subTitle += " ÈáëËûçüîÑ";
				} else if (obj.errorMsg == "Êñ≠Á≠æ") {
					$.fbroken = true;
				} else {
					throw new ERR.BodyError(obj.errorMsg);
				}
			} else {
				throw new ERR.BodyError(JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			throw err;
		});
}

function restartFinace() {
	return $.post({
		url: financeURL + "/restart",
		headers: {
			"Content-Type": "application/json",
		},
		body: '{"token":"' + $.Ticket + '","activityId":"' + $.financeActId + '","clientId":1}',
	})
		.then((resp) => {
			$.log("restart: " + JSON.stringify(resp.body));
		})
		.catch((err) => {
			throw err;
		});
}

async function instance() {
	$.joinInstance = false;
	$.instancechoose = await Choose($.activity_instance_id);
	await joinInstance();
	if ($.joinInstance) {
		await getInstance();
		await rewardInstance();
	}
}

function joinInstance() {
	$.log($.instancechoose);
	return $.post({
		url: mainURL + "/toggle/api/instance/join?ticket=" + encodeURIComponent($.Ticket),
		headers: {
			"Content-Type": "application/x-www-form-urlencoded",
		},
		body: "scene=" + $.instanceScene + "&activity_instance_id=" + $.instancechoose,
	})
		.then((resp) => {
			$.log("joinInstance: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.joinInstanceFlag = true;
			}
		})
		.catch((err) => {
			$.error("joinInstance: \n");
			$.error(err);
		});
}

function getInstance() {
	return $.get({
		url:
			mainURL +
			"/toggle/api/instance/getInstanceByInstanceID?scene=" +
			$.instanceScene +
			"&activity_instance_id=" +
			$.instancechoose +
			"&ticket=" +
			$.Ticket +
			"&need_reward=true",
	})
		.then((resp) => {
			$.log("getInstance: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			$.instance_activity_id = obj.data.activity_info.activity_id;
		})
		.catch((err) => {
			$.error("getInstance: \n");
			$.error(err);
		});
}

function rewardInstance() {
	return $.get({
		url:
			mainURL +
			"/toggle/api/query/queryAvailableReward?token=" +
			$.Ticket +
			"&scene=" +
			$.instanceScene +
			"&activity_id=" +
			$.instance_activity_id,
	})
		.then((resp) => {
			$.log("rewardInstance: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			for (let c of obj.data.batchs) {
				$.detail += "\n" + c.batch_name + "Ôºö" + c.remark;
			}
		})
		.catch((err) => {
			$.error("rewardInstance: \n");
			$.error(err);
		});
}

function grabCoupons(id) {
	return $.post({
		url: mainURL + "/wechat/soraka/gainAward",
		headers: {
			"Content-Type": "application/json",
			"Didi-Ticket": $.Ticket,
		},
		body: '{"app_id":"common","city_id":"' + $.city + '","act_id":"' + id + '"}',
	})
		.then((resp) => {
			$.log("time: " + $.now + "\naward[" + id + "]: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.detail += "\nÊä¢Âà∞Ôºö" + obj.data.act_name + "„ÄÇ";
			} else if (obj.errno == 12000 || obj.errno == 13000) {
				$.detail += "\n" + id + ": Ê≠§Âà∏" + obj.errmsg + "„ÄÇ";
			} else if (obj.errno == 114514) {
				throw new ERR.BodyError("ËØ∑Ê±Ç‰ΩìÈîôËØØÔºåËØ∑ÂºÄÂêØÊäìÂåÖËøêË°åËÑöÊú¨ÂêéÂèçÈ¶àÊäìÂåÖÂÜÖÂÆπ„ÄÇ");
			} else {
				$.error(resp.body);
				throw new ERR.BodyError(
					id + ": Êä¢Âà∏ËøîÂõûÈîôËØØÔºåËØ∑Âú® BoxJs ‰∏≠ÂºÄÂêØË∞ÉËØïÊ®°ÂºèËøêË°åÂêéÂèçÈ¶àÊó•Âøó„ÄÇ\n" + obj.errmsg
				);
			}
		})
		.catch((err) => {
			throw err;
		});
}

async function steps() {
	$.stepFlag = true;
	$.stepInfoBody = aff
		? '{"step_count":"' +
		  Math.round(Math.random() * 5000 + 20001) +
		  '","share_source_id":"' +
		  Choose($.step_share_source_id) +
		  '","share_date":"' +
		  today.replace(/-/g, "") +
		  '"}'
		: '{"step_count":"' +
		  Math.round(Math.random() * 5000 + 20001) +
		  '","share_source_id":"","share_date":""}';
	await stepInfo();
	if ($.stepFlag) {
		await stepBonus();
		await stepSign();
		await stepMatch();
	}
}

function stepInfo() {
	return $.post({
		url: stepURL + "/step/info",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body: $.stepInfoBody,
	})
		.then((resp) => {
			$.log("stepInfo: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.info("DiDi step share_source_id: " + obj.data.share.share_source_id);
				$.todayStep = obj.data.greeting.today_step;
				$.stepShareActivityId = obj.data.task.activity_id;
			} else {
				$.stepFlag = false;
				$.info(
					"stepInfo: " + JSON.stringify(resp.body) + "\n" + "ËØ∑Ê£ÄÊü•ÊòØÂê¶ÊúâËµ∞Ë∑ØËµöÈí±Ê¥ªÂä®„ÄÇ"
				);
			}
		})
		.catch((err) => {
			$.error("stepInfo: \n");
			$.error(err);
		});
}

function stepBonus() {
	return $.post({
		url: stepURL + "/step/getBonus",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body: "{}",
	})
		.then((resp) => {
			$.log("stepBonus: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				if (obj.data.bonus_amount) {
					let stepBonus = obj.data.bonus_amount;
					$.detail += "‰∏ä‰º† " + $.todayStep + " Ê≠•ÔºåÂ∑≤È¢ÜÂèñ " + stepBonus + " Á¶èÂà©Èáë„ÄÇ";
				} else {
					$.detail += "Ê≠•Êï∞ËææÊ†áÁ¶èÂà©Èáë" + obj.data.message_text + "„ÄÇ";
				}
			} else {
				$.info("stepBonus: " + JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			$.error("stepBonus: \n");
			$.error(err);
		});
}

function stepSign() {
	return $.post({
		url: stepURL + "/step/sign",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body: '{"city_id":"' + $.city + '"}',
	})
		.then((resp) => {
			$.log("stepSign: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				if (obj.data.type == 1) {
					let stepSignBonus = obj.data.amount;
					$.detail +=
						"Ê≠•Êï∞Á≠æÂà∞Â•ñÂä± " + stepSignBonus + " Á¶èÂà©Èáë„ÄÇ\n" + obj.data.sign_text;
				} else if (obj.data.type == 4) {
					let stepSignBonus = obj.data.amount / 100;
					$.detail += "Ê≠•Êï∞Á≠æÂà∞Â•ñÂä± " + stepSignBonus + " ÂÖÉ„ÄÇ\n" + obj.data.sign_text;
				} else if (obj.data.type == 0) {
					$.detail += "Ê≠•Êï∞Á≠æÂà∞Â•ñÂä±" + obj.data.message_text + "„ÄÇ";
				} else {
					$.detail += "Ê≠•Êï∞Á≠æÂà∞Â•ñÂä±Êú™Áü•Á±ªÂûãÔºö" + JSON.stringify(resp.body);
				}
			} else {
				$.info("stepSign: " + JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			$.error("stepSign: \n");
			$.error(err);
		});
}

async function stepMatch() {
	$.todayDate = today.replace(/-/g, "").substr(4);
	$.stepMatchState = 1;
	while ($.stepMatchState == 1) {
		await stepMatchInfo();
		if ($.stepMatchState == 1) {
			await stepMatchReceive();
			await stepMatchSubmit();
		} else if ($.stepMatchState == 2) {
			await stepMatchSubmit();
			await stepMatchJoin();
		} else if ($.stepMatchState == 3) {
			await stepMatchJoin();
		}
	}
}

function stepMatchInfo() {
	return $.post({
		url: stepURL + "/match/info",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body: '{"step_count":"' + $.todayStep + '"}',
	})
		.then((resp) => {
			$.log("stepMatchInfo: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.log("DiDi stepMatch share_md5_id: " + obj.data.log_data.share_md5_id);
				let todayDate = today.replace(/-/g, "").substr(4);
				let objUpperDate = obj.data.upper_info.activity_date;
				if (objUpperDate < todayDate || (todayDate == "0101" && objUpperDate == "1231")) {
					$.stepMatchState = 1;
					$.stepMatchReceiveActivityId = obj.data.upper_info.activity_id;
					$.stepMatchReceiveTaskId =
						obj.data.upper_info.step_stage[
							obj.data.upper_info.step_stage.length - 1
						].task_id;
				} else if (objUpperDate == todayDate) {
					$.stepMatchState = 2;
					$.stepMatchSubmitActivityId = obj.data.upper_info.activity_id;
					$.stepMatchSubmitTaskId =
						obj.data.upper_info.step_stage[
							obj.data.upper_info.step_stage.length - 1
						].task_id;
					$.stepMatchJoinActivityId = obj.data.lower_info.activity_id;
					$.stepMatchJoinTaskId =
						obj.data.lower_info.step_stage[
							obj.data.lower_info.step_stage.length - 1
						].task_id;
					$.stepMatchJoinBonus =
						obj.data.upper_info.step_stage[
							obj.data.upper_info.step_stage.length - 1
						].step_bonus;
				} else if (
					objUpperDate > todayDate ||
					(todayDate == "1231" && objUpperDate == "0101")
				) {
					$.stepMatchState = 3;
					$.stepMatchJoinActivityId = obj.data.upper_info.activity_id;
					$.stepMatchJoinTaskId =
						obj.data.upper_info.step_stage[
							obj.data.upper_info.step_stage.length - 1
						].task_id;
					$.stepMatchJoinBonus =
						obj.data.upper_info.step_stage[
							obj.data.upper_info.step_stage.length - 1
						].step_bonus;
				}
			} else {
				$.stepMatchState = 0;
				$.info(
					"stepMatchInfo: " +
						JSON.stringify(resp.body) +
						"\n" +
						"ËØ∑Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§©Â§©Ê≠•Êï∞ËµõÊ¥ªÂä®„ÄÇ"
				);
			}
		})
		.catch((err) => {
			$.stepMatchState = -1;
			$.detail += "\nÊ≠•Êï∞ËµõÊé•Âè£ÈîôËØØ„ÄÇ";
			$.error("stepMatchInfo: \n");
			$.error(err);
		});
}

function stepMatchReceive() {
	return $.post({
		url: stepURL + "/match/receive",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body:
			'{"type":2,"activity_id":' +
			$.stepMatchReceiveActivityId +
			',"task_id":' +
			$.stepMatchReceiveTaskId +
			"}",
	})
		.then((resp) => {
			$.log("stepMatchReceive: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.detail +=
					"\n" +
					(obj.data.amount
						? "Êò®Êó•Ê≠•Êï∞ËµõÂÆåÊàêÂ•ñÂä± " + obj.data.amount + " Á¶èÂà©Èáë„ÄÇ"
						: "Ê≠•Êï∞ËµõÂ•ñÂä±Ôºö" + JSON.stringify(obj.data));
			} else {
				$.info("stepMatchInfo: " + JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			$.error("stepMatchReceive: \n");
			$.error(err);
		});
}

function stepMatchSubmit() {
	return $.post({
		url: stepURL + "/match/submit",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body:
			'{"activity_id":' +
			$.stepMatchSubmitActivityId +
			',"task_id":' +
			$.stepMatchSubmitTaskId +
			',"step_count":' +
			$.todayStep +
			"}",
	})
		.then((resp) => {
			$.log("stepMatchSubmit: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.detail +=
					"\n" +
					(obj.data.type == 1 || obj.data.type == 2
						? "‰ªäÊó•Ê≠•Êï∞ËµõÊàêÂäüÊèê‰∫§ " + $.todayStep + " Ê≠•„ÄÇ"
						: "Ê≠•Êï∞ËµõÊèê‰∫§Ôºö" + JSON.stringify(obj.data));
			} else {
				$.info("stepMatchSubmit: " + JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			$.error("stepMatchSubmit: \n");
			$.error(err);
		});
}

function stepMatchJoin() {
	return $.post({
		url: stepURL + "/match/join",
		headers: {
			"Content-Type": "application/json",
			ticket: $.Ticket,
		},
		body:
			'{"type":2,"activity_id":' +
			$.stepMatchJoinActivityId +
			',"task_id":' +
			$.stepMatchJoinTaskId +
			"}",
	})
		.then((resp) => {
			$.log("stepMatchJoin: " + JSON.stringify(resp.body));
			let obj = JSON.parse(resp.body);
			if (obj.errno == 0) {
				$.detail +=
					"\n" +
					(obj.data.type == 1
						? "ÊòéÊó•Ê≠•Êï∞ËµõÊä•ÂêçËä±Ë¥π " + $.stepMatchJoinBonus + " Á¶èÂà©Èáë„ÄÇ"
						: "Ê≠•Êï∞ËµõÊä•ÂêçÔºö" + JSON.stringify(obj.data));
			} else {
				$.info("stepMatchJoin: " + JSON.stringify(resp.body));
			}
		})
		.catch((err) => {
			$.error("stepMatchJoin: \n");
			$.error(err);
		});
}

async function tree() {
	await treeLogin();
	await treeTask();
	await treeWater();
	await treeFertilize();
	await treeDbox();
	await treeLogout();
}

function getToken() {
	let appreg = /^https:\/\/as\.xiaojukeji\.com\/ep\/as\/toggles\?.*city=(\d+)&.*ticket=(.*?)&/;
	let minireg = /^https:\/\/common\.diditaxi\.com\.cn\/webapp\/config\/sidebar\?.*token=(.*?)&.*cityid=(\d+)/;
	if (appreg.exec($request.url)) {
		let CityValue = appreg.exec($request.url)[1];
		let TokenValue = decodeURIComponent(appreg.exec($request.url)[2]);
		if ($.read("#DiDi") != (undefined || null)) {
			if ($.read("#DiDi") != TokenValue || $.read("#DiDi_city") != CityValue) {
				$.write(TokenValue, "#DiDi");
				$.write(CityValue, "#DiDi_city");
				$.notify("Êõ¥Êñ∞ " + $.name + " Token ÊàêÂäü üéâ", "", "");
			}
		} else {
			$.write(TokenValue, "#DiDi");
			$.write(CityValue, "#DiDi_city");
			$.notify("È¶ñÊ¨°ÂÜôÂÖ• " + $.name + " Token ÊàêÂäü üéâ", "", "");
		}
	} else if (minireg.exec($request.url)) {
		let CityValue = minireg.exec($request.url)[2];
		let TokenValue = decodeURIComponent(minireg.exec($request.url)[1]);
		if ($.read("#DiDi") != (undefined || null)) {
			if ($.read("#DiDi") != TokenValue || $.read("#DiDi_city") != CityValue) {
				$.write(TokenValue, "#DiDi");
				$.write(CityValue, "#DiDi_city");
				$.notify("Êõ¥Êñ∞ " + $.name + " Token ÊàêÂäü üéâ", "", "");
			}
		} else {
			$.write(TokenValue, "#DiDi");
			$.write(CityValue, "#DiDi_city");
			$.notify("È¶ñÊ¨°ÂÜôÂÖ• " + $.name + " Token ÊàêÂäü üéâ", "", "");
		}
	} else {
		$.notify("ÂÜôÂÖ•" + $.name + " Token Â§±Ë¥•‚ÄºÔ∏è", "", "ËØ∑ÂºÄÂêØÂÆö‰ΩçÊùÉÈôêÔºåÈáçÂºÄËΩØ‰ª∂ÈáçÊñ∞Ëé∑Âèñ„ÄÇ");
	}
}

function MYERR() {
	class TokenError extends Error {
		constructor(message) {
			super(message);
			this.name = "TokenError";
		}
	}

	class BodyError extends Error {
		constructor(message) {
			super(message);
			this.name = "BodyError";
		}
	}

	return {
		TokenError,
		BodyError,
	};
}

// prettier-ignore
// isJSON
function isJSON(t){if("string"==typeof t)try{let r=JSON.parse(t);return!("object"!=typeof r||!r)&&r}catch(t){return!1}return!1}
// prettier-ignore
// OpenAPI by Peng-YM, modified by zZPiglet
function API(e="untitled",s=!1){return new class{constructor(e,s){this.name=e,this.debug=s,this.isRequest="undefined"!=typeof $request,this.isQX="undefined"!=typeof $task,this.isLoon="undefined"!=typeof $loon,this.isSurge="undefined"!=typeof $httpClient&&!this.isLoon,this.isNode="function"==typeof require,this.isJSBox=this.isNode&&"undefined"!=typeof $jsbox,this.node=(()=>{if(this.isNode){const e="undefined"!=typeof $request?void 0:require("request"),s=require("fs");return{request:e,fs:s}}return null})(),this.initCache();const t=(e,s)=>new Promise(function(t){setTimeout(t.bind(null,s),e)});Promise.prototype.delay=function(e){return this.then(function(s){return t(e,s)})}}get(e){return this.isQX?("string"==typeof e&&(e={url:e,method:"GET"}),$task.fetch(e)):new Promise((s,t)=>{this.isLoon||this.isSurge?$httpClient.get(e,(e,i,o)=>{e?t(e):s({statusCode:i.status,headers:i.headers,body:o})}):this.node.request(e,(e,i,o)=>{e?t(e):s({...i,statusCode:i.statusCode,body:o})})})}post(e){return e.body&&e.headers&&!e.headers["Content-Type"]&&(e.headers["Content-Type"]="application/x-www-form-urlencoded"),this.isQX?("string"==typeof e&&(e={url:e}),e.method="POST",$task.fetch(e)):new Promise((s,t)=>{this.isLoon||this.isSurge?$httpClient.post(e,(e,i,o)=>{e?t(e):s({statusCode:i.status,headers:i.headers,body:o})}):this.node.request.post(e,(e,i,o)=>{e?t(e):s({...i,statusCode:i.statusCode,body:o})})})}initCache(){if(this.isQX&&(this.cache=JSON.parse($prefs.valueForKey(this.name)||"{}")),(this.isLoon||this.isSurge)&&(this.cache=JSON.parse($persistentStore.read(this.name)||"{}")),this.isNode){let e="root.json";this.node.fs.existsSync(e)||this.node.fs.writeFileSync(e,JSON.stringify({}),{flag:"wx"},e=>console.log(e)),this.root={},e=`${this.name}.json`,this.node.fs.existsSync(e)?this.cache=JSON.parse(this.node.fs.readFileSync(`${this.name}.json`)):(this.node.fs.writeFileSync(e,JSON.stringify({}),{flag:"wx"},e=>console.log(e)),this.cache={})}}persistCache(){const e=JSON.stringify(this.cache);this.isQX&&$prefs.setValueForKey(e,this.name),(this.isLoon||this.isSurge)&&$persistentStore.write(e,this.name),this.isNode&&(this.node.fs.writeFileSync(`${this.name}.json`,e,{flag:"w"},e=>console.log(e)),this.node.fs.writeFileSync("root.json",JSON.stringify(this.root),{flag:"w"},e=>console.log(e)))}write(e,s){this.log(`SET ${s}`),-1!==s.indexOf("#")?(s=s.substr(1),(this.isSurge||this.isLoon)&&$persistentStore.write(e,s),this.isQX&&$prefs.setValueForKey(e,s),this.isNode&&(this.root[s]=e)):this.cache[s]=e,this.persistCache()}read(e){return this.log(`READ ${e}`),-1===e.indexOf("#")?this.cache[e]:(e=e.substr(1),this.isSurge||this.isLoon?$persistentStore.read(e):this.isQX?$prefs.valueForKey(e):this.isNode?this.root[e]:void 0)}delete(e){this.log(`DELETE ${e}`),-1!==e.indexOf("#")?(e=e.substr(1),(this.isSurge||this.isLoon)&&$persistentStore.write(null,e),this.isQX&&$prefs.removeValueForKey(e),this.isNode&&delete this.root[e]):delete this.cache[e],this.persistCache()}notify(s=e,t="",i="",o,n){if(this.isSurge){let e=i+(null==n?"":`\n\nÂ§öÂ™í‰ΩìÈìæÊé•Ôºö${n}`),r={};o&&(r.url=o),"{}"==JSON.stringify(r)?$notification.post(s,t,e):$notification.post(s,t,e,r)}if(this.isQX){let e={};o&&(e["open-url"]=o),n&&(e["media-url"]=n),"{}"==JSON.stringify(e)?$notify(s,t,i):$notify(s,t,i,e)}if(this.isLoon){let e={};o&&(e.openUrl=o),n&&(e.mediaUrl=n),"{}"==JSON.stringify(e)?$notification.post(s,t,i):$notification.post(s,t,i,e)}if(this.isNode){let e=i+(null==o?"":`\n\nË∑≥ËΩ¨ÈìæÊé•Ôºö${o}`)+(null==n?"":`\n\nÂ§öÂ™í‰ΩìÈìæÊé•Ôºö${n}`);if(this.isJSBox){const i=require("push");i.schedule({title:s,body:t?t+"\n"+e:e})}else console.log(`${s}\n${t}\n${e}\n\n`)}}log(e){this.debug&&console.log(e)}info(e){console.log(e)}error(e){console.log("ERROR: "+e)}wait(e){return new Promise(s=>setTimeout(s,e))}done(e={}){this.isQX||this.isLoon||this.isSurge?this.isRequest?$done(e):$done():this.isNode&&!this.isJSBox&&"undefined"!=typeof $context&&($context.headers=e.headers,$context.statusCode=e.statusCode,$context.body=e.body)}}(e,s)}
