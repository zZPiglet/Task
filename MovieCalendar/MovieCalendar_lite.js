/*
è±†ç“£ç”µå½±æ—¥å†æ¯æ—¥é€šçŸ¥ã€‚

å…³äºè±†ç“£ APIKeyï¼š
ç”±äºå®˜æ–¹å–æ¶ˆäº† APIKey çš„ç”³è¯·ï¼Œè¯·è‡ªè¡Œè§£å†³æ­¤é—®é¢˜ï¼š
1. ç½‘ä¸Šæ‰¾åˆ«äººä¹‹å‰ç”³è¯·çš„ï¼ˆå…³é”®å­—ï¼šè±†ç“£ API Keyï¼‰
2. ä¸‹è½½ app è‡ªè¡ŒæŠ“åŒ… / é‡å†™è·å–æœ¬æœºä¸Šçš„

è‹¥é€‰æ‹©åˆ©ç”¨é‡å†™è·å¾—ï¼Œè¯·å…ˆæŒ‰ä¸‹è¿°æ–¹æ³•è¿›è¡Œé…ç½®ï¼Œè¿›å…¥ ï£¿ widget ç•Œé¢ï¼ˆiOS 13 è´Ÿä¸€å±ï¼‰ï¼Œæ·»åŠ ã€Œè±†ç“£Â·ç”µå½±æ—¥å†ã€ï¼Œå¹¶é‡æ–°è¿›å…¥æ­¤ç•Œé¢ä½¿å…¶åˆ·æ–°è·å–å†…å®¹ï¼Œè‹¥å¼¹å‡º"é¦–æ¬¡å†™å…¥ MovieCalendar APIKey æˆåŠŸ"å³å¯æ­£å¸¸é£Ÿç”¨ï¼Œå…¶ä»–æç¤ºæˆ–æ— æç¤ºè¯·ä½¿ç”¨å…¶ä»–æ–¹æ³•è·å– APIKey å¹¶å¡«å…¥ BoxJsã€‚

æœ¬è„šæœ¬åœ¨ Quantumult X(build 316+) ä¸­å¯åšåˆ°æ˜¾ç¤ºå¤šåª’ä½“ï¼Œå¹¶å¯ç‚¹å‡»é€šçŸ¥è·³è½¬ã€‚
æœ¬è„šæœ¬åœ¨ Loon(build 163+) ä¸­å¯åšåˆ°æ˜¾ç¤ºå¤šåª’ä½“é“¾æ¥ï¼Œå¹¶å¯ç‚¹å‡»é€šçŸ¥è·³è½¬ã€‚
æœ¬è„šæœ¬åœ¨ Surge ä¸­ä¼šæç¤ºå¤šåª’ä½“é“¾æ¥åŠè·³è½¬é“¾æ¥ï¼Œéœ€é•¿æŒ‰é€šçŸ¥å†ç‚¹å‡»é“¾æ¥è¿›è¡Œè·³è½¬ã€‚

å¤šåª’ä½“å¯é€‰æ‹©ä¸ºã€Œç”µå½±å‰§ç…§ã€ã€ã€Œç”µå½±æµ·æŠ¥ã€ã€ã€Œé¢„å‘Šç‰‡ã€ï¼Œé»˜è®¤ä¸ºã€Œç”µå½±å‰§ç…§ã€ï¼Œå¯åœ¨ BoxJs ä¸­æ›´æ”¹é…ç½®ã€‚
è·³è½¬å¯é€‰å®šæŒ‡å®šå®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¸º Safariï¼Œå¯åœ¨ BoxJs ä¸­æ›´æ”¹è‡³è±†ç“£å®˜æ–¹å®¢æˆ·ç«¯ã€‚

âš ï¸å…è´£å£°æ˜ï¼š
1. æ­¤è„šæœ¬ä»…ç”¨äºå­¦ä¹ ç ”ç©¶ï¼Œä¸ä¿è¯å…¶åˆæ³•æ€§ã€å‡†ç¡®æ€§ã€æœ‰æ•ˆæ€§ï¼Œè¯·æ ¹æ®æƒ…å†µè‡ªè¡Œåˆ¤æ–­ï¼Œæœ¬äººå¯¹æ­¤ä¸æ‰¿æ‹…ä»»ä½•ä¿è¯è´£ä»»ã€‚
2. ç”±äºæ­¤è„šæœ¬ä»…ç”¨äºå­¦ä¹ ç ”ç©¶ï¼Œæ‚¨å¿…é¡»åœ¨ä¸‹è½½å 24 å°æ—¶å†…å°†æ‰€æœ‰å†…å®¹ä»æ‚¨çš„è®¡ç®—æœºæˆ–æ‰‹æœºæˆ–ä»»ä½•å­˜å‚¨è®¾å¤‡ä¸­å®Œå…¨åˆ é™¤ï¼Œè‹¥è¿åè§„å®šå¼•èµ·ä»»ä½•äº‹ä»¶æœ¬äººå¯¹æ­¤å‡ä¸è´Ÿè´£ã€‚
3. è¯·å‹¿å°†æ­¤è„šæœ¬ç”¨äºä»»ä½•å•†ä¸šæˆ–éæ³•ç›®çš„ï¼Œè‹¥è¿åè§„å®šè¯·è‡ªè¡Œå¯¹æ­¤è´Ÿè´£ã€‚
4. æ­¤è„šæœ¬æ¶‰åŠåº”ç”¨ä¸æœ¬äººæ— å…³ï¼Œæœ¬äººå¯¹å› æ­¤å¼•èµ·çš„ä»»ä½•éšç§æ³„æ¼æˆ–å…¶ä»–åæœä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚
5. æœ¬äººå¯¹ä»»ä½•è„šæœ¬å¼•å‘çš„é—®é¢˜æ¦‚ä¸è´Ÿè´£ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç”±è„šæœ¬é”™è¯¯å¼•èµ·çš„ä»»ä½•æŸå¤±å’ŒæŸå®³ã€‚
6. å¦‚æœä»»ä½•å•ä½æˆ–ä¸ªäººè®¤ä¸ºæ­¤è„šæœ¬å¯èƒ½æ¶‰å«Œä¾µçŠ¯å…¶æƒåˆ©ï¼Œåº”åŠæ—¶é€šçŸ¥å¹¶æä¾›èº«ä»½è¯æ˜ï¼Œæ‰€æœ‰æƒè¯æ˜ï¼Œæˆ‘ä»¬å°†åœ¨æ”¶åˆ°è®¤è¯æ–‡ä»¶ç¡®è®¤ååˆ é™¤æ­¤è„šæœ¬ã€‚
7. æ‰€æœ‰ç›´æ¥æˆ–é—´æ¥ä½¿ç”¨ã€æŸ¥çœ‹æ­¤è„šæœ¬çš„äººå‡åº”è¯¥ä»”ç»†é˜…è¯»æ­¤å£°æ˜ã€‚æœ¬äººä¿ç•™éšæ—¶æ›´æ”¹æˆ–è¡¥å……æ­¤å£°æ˜çš„æƒåˆ©ã€‚ä¸€æ—¦æ‚¨ä½¿ç”¨æˆ–å¤åˆ¶äº†æ­¤è„šæœ¬ï¼Œå³è§†ä¸ºæ‚¨å·²æ¥å—æ­¤å…è´£å£°æ˜ã€‚

Authorï¼šzZPiglet
lite edition: notify modified by @vopacc

Quantumult X:
[task_local]
0 7 * * * https://raw.githubusercontent.com/zZPiglet/Task/master/MovieCalendar/MovieCalendar.js, tag=ç”µå½±æ—¥å†

[rewrite_local]
^https:\/\/frodo\.douban\.com\/api\/v\d\/calendar\/today url script-request-header https://raw.githubusercontent.com/zZPiglet/Task/master/MovieCalendar/MovieCalendar.js


Surge & Loon:
[Script]
cron "0 7 * * *" script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/MovieCalendar/MovieCalendar.js
http-request ^https:\/\/frodo\.douban\.com\/api\/v\d\/calendar\/today script-path=https://raw.githubusercontent.com/zZPiglet/Task/master/MovieCalendar/MovieCalendar.js

All app:
[mitm]
hostname = frodo.douban.com

è·å–å®Œ APIKey å›  MitM å¯¼è‡´è¯¥è½¯ä»¶ç½‘ç»œä¸ç¨³å®šï¼Œéœ€æ³¨é‡Šæ‰ hostnameã€‚
*/

// sloarToLunar.js by xm2by, modified by zZPiglet
function toLunar(a,r,n){r-=1;let e,t,l,u=(Date.UTC(a,r,n)-Date.UTC(1949,0,29))/864e5+1;for(let a=0;a<lunarYearArr.length;a++)if(u-=lunarYearDays(lunarYearArr[a]),u<=0){e=1949+a,u+=lunarYearDays(lunarYearArr[a]);break}for(let a=0;a<lunarYearMonths(lunarYearArr[e-1949]).length;a++)if(u-=lunarYearMonths(lunarYearArr[e-1949])[a],u<=0){t=hasLeapMonth(lunarYearArr[e-1949])&&hasLeapMonth(lunarYearArr[e-1949])<=a?hasLeapMonth(lunarYearArr[e-1949])<a?a:hasLeapMonth(lunarYearArr[e-1949])===a?"é—°"+a:a+1:a+1,u+=lunarYearMonths(lunarYearArr[e-1949])[a];break}return l=u,t=hasLeapMonth(lunarYearArr[e-1949])&&"string"==typeof t&&t.indexOf("é—°")>-1?`é—°${lunarMonth[/\d/.exec(t)-1]}`:lunarMonth[t-1],e=getTianGan(e)+getDiZhi(e),l<11?l=`${lunarDay[10]}${lunarDay[l-1]}`:l>10&&l<20?l=`${lunarDay[9]}${lunarDay[l-11]}`:20===l?l=`${lunarDay[1]}${lunarDay[9]}`:l>20&&l<30?l=`${lunarDay[11]}${lunarDay[l-21]}`:30===l&&(l=`${lunarDay[2]}${lunarDay[9]}`),e+"å¹´"+t+"æœˆ"+l+"æ—¥"}function hasLeapMonth(a){return!!(15&a)&&15&a}function leapMonthDays(a){return hasLeapMonth(a)?983040&a?30:29:0}function lunarYearDays(a){let r=0;for(let n=32768;n>8;n>>=1){let e=a&n?30:29;r+=e}return hasLeapMonth(a)&&(r+=leapMonthDays(a)),r}function lunarYearMonths(a){let r=[];for(let n=32768;n>8;n>>=1)r.push(a&n?30:29);return hasLeapMonth(a)&&r.splice(hasLeapMonth(a),0,leapMonthDays(a)),r}function getTianGan(a){let r=(a-3)%10;return 0===r&&(r=10),tianGan[r-1]}function getDiZhi(a){let r=(a-3)%12;return 0===r&&(r=12),diZhi[r-1]}let lunarYearArr=[46423,27808,46416,86869,19872,42416,83315,21168,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46752,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19195,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448,84835,37744,18936,18800,25776,92326,59984,27424,108228,43744,41696,53987,51552,54615,54432,55888,23893,22176,42704,21972,21200,43448,43344,46240,46758,44368,21920,43940,42416,21168,45683,26928,29495,27296,44368,84821,19296,42352,21732,53600,59752,54560,55968,92838,22224,19168,43476,41680,53584,62034,54560],lunarMonth=["æ­£","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å","å†¬","è…Š"],lunarDay=["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å","åˆ","å»¿"],tianGan=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"],diZhi=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];

const $ = new API("MovieCalendar");
$.debug = [true, "true"].includes($.read("debug")) || false;
const ERR = MYERR();
const year = new Date().getFullYear();
const month = new Date().getMonth() + 1;
const day = new Date().getDate();
const week = "æ˜ŸæœŸ"+"æ—¥ä¸€äºŒä¸‰å››äº”å…­".charAt(new Date().getDay());
const today = year + "-" + ("00" + month).substr(-2) + "-" + ("00" + day).substr(-2);
const todaylunar = toLunar(year,month,day);
const reg = /https:\/\/frodo\.douban\.com\/api\/v\d\/calendar\/today.*apikey=(\w*)/;
$.time = Number($.read("time") || 10);
$.pic = $.read("choosePic") || "poster";
$.client = $.read("chooseClient") || "Safari";
if ($.client == "Safari") {
    $.openlink = "https://www.douban.com/doubanapp/dispatch/movie/";
} else if ($.client == "douban") {
    $.openlink = "douban://douban.com/movie/";
}
const boxhost = $.read("#boxjs_host") || "http://boxjs.com";
$.diylink = $.read("diylink") || boxhost + "/app/zZ.Douban"; 

if ($.isRequest) {
    getAPIKey();
    $.done({ body: $request.body });
} else {
    !(async () => {
        $.apikey = $.read("apikey");
        if (!$.apikey) {
            throw new ERR.APIKeyError("âŒ æœªè·å–æˆ–å¡«å†™ APIKey");
        } else {
            $.code = "997"
            $.Cnt = 0;
            while ($.Cnt < $.time && $.code == "997") {
                await getCalendar();
            }
            if ($.comment) await getTrailer();
            await notify();
        }
    })().catch((err) => {
        if (err instanceof ERR.APIKeyError) {
            $.notify("ç”µå½±æ—¥å† - APIKey é”™è¯¯", "", err.message, boxhost + "/app/zZ.Douban");
        } else if (err instanceof ERR.bodyError) {
            $.notify("ç”µå½±æ—¥å† - è¿”å›é”™è¯¯", "", err.message);
        } else {
            $.notify("ç”µå½±æ—¥å† - å‡ºç°é”™è¯¯", "", JSON.stringify(err));
            $.error(JSON.stringify(err));
        }
    }).finally($.done())
}

function getCalendar() {
    return $.get({
        url: "https://frodo.douban.com/api/v2/calendar/today?alt=json&apikey=" + $.apikey + "&date=" + today,
        headers: {
            "User-Agent": "api-client/0.1.3 com.douban.frodo/6.40.0"
        }
    })
        .then((resp) => {
            $.log("getCalendar: " + JSON.stringify(resp.body));
            let obj = JSON.parse(resp.body);
            $.code = obj.code
            if (obj.comment) {
                $.comment = obj.comment.content;
                $.poster = obj.comment.poster;
                $.solarterm = obj.today.title;
                $.movie = "ã€Š" + obj.subject.title + "ã€‹";
                $.movieid = obj.subject.id;
                $.cover = obj.subject.pic.large;
                $.movieinfo = obj.subject.card_subtitle;
                $.rating = Number(obj.subject.rating.value).toFixed(1);
                let entire = "â˜…";
                let half = "â˜†";
                let blank = "â—‹";
                let starnum = Number(obj.subject.rating.star_count);
                $.star = entire.repeat(parseInt(starnum)) + (starnum*10%10 ? half : "") + blank.repeat(parseInt(5 - starnum));
            } else if (obj.code == "104") {
                throw new ERR.APIKeyError("âŒ APIKey å¤±æ•ˆ");
            } else if (obj.code == "997") {
                $.Cnt += 1;
            } else {
                throw new ERR.bodyError(JSON.stringify(resp.body));
            }
        })
        .catch((err) => {
            throw err;
        })

}

function getTrailer() {
    return $.get({
        url: "https://m.douban.com/rexxar/api/v2/movie/" + $.movieid + "?ck=&for_mobile=1",
        headers: {
            "Referer": "https://m.douban.com"
        }
    })
        .then((resp) => {
            $.log("getTrailer: " + JSON.stringify(resp.body));
            let obj = JSON.parse(resp.body);
            $.trailer = obj.trailer.video_url;
            $.intro = obj.intro;
        })
        .catch((err) => {
            throw err;
        })
}

async function notify() {
    if ($.Cnt < $.time) {
        let Title = month + " æœˆ " + day +  "æ—¥ï½œ" + todaylunar + "ï½œ" + week;
        if ($.solarterm) Title += "ï½œ" + $.solarterm;
        let subTitle = $.movie + $.star + "\xa0\xa0\xa0\xa0" + $.rating + "/10";
        let detail = $.comment;
        detail += "\n\n" + $.movieinfo;
        detail += "\nç®€ä»‹ï¼š\n" + $.intro 
        let openurl = $.openlink + $.movieid;
        let imgurl = $.poster;
        if ($.pic == "cover") {
            imgurl = $.cover;
        } else if ($.pic == "trailer") {
            imgurl = $.trailer;
        }
        if ($.client = "diy") openurl = $.diylink; 
        $.notify(Title, subTitle, detail, openurl, imgurl)
    } else {
        $.notify("ç”µå½±æ—¥å† - å‡ºç°é”™è¯¯", "", "æ¥å£è¿”å›é”™è¯¯ï¼Œè¶…å‡ºé‡è¯•æ¬¡æ•°ã€‚\næˆ–ç­¾ååŠ å¯†é”™è¯¯ï¼Œè¯·ç­‰å¾…è§£å†³ã€‚")
    }
}

function getAPIKey() {
    $.log($request.url)
    if (reg.exec($request.url)[1]) {
        let APIKeyValue = reg.exec($request.url)[1];
        if ($.read("apikey") != (undefined || null)) {
            if ($.read("apikey") != APIKeyValue) {
                $.write(APIKeyValue, "apikey")
                $.notify("æ›´æ–° " + $.name + " APIKey æˆåŠŸ ğŸ‰", "", "")
            }
        } else {
            $.write(APIKeyValue, "apikey")
            $.notify("é¦–æ¬¡å†™å…¥ " + $.name + " APIKey æˆåŠŸ ğŸ‰", "", "")
        }
    } else {
        $.notify("å†™å…¥" + $.name + "APIKey å¤±è´¥â€¼ï¸", "", "é…ç½®é”™è¯¯, æ— æ³•è¯»å–è¯·æ±‚å¤´ã€‚")
    }
}

function MYERR() {
    class APIKeyError extends Error {
        constructor(message) {
            super(message);
            this.name = "APIKeyError";
        }
    };
    class bodyError extends Error {
        constructor(message) {
            super(message);
            this.name = "bodyError";
        } 
    };
  
    return {
        APIKeyError,
        bodyError,
    };
}

// OpenAPI by Peng-YM, modified by zZPiglet
function API(s="untitled",e=!1){return new class{constructor(s,e){this.name=s,this.debug=e,this.isRequest="undefined"!=typeof $request,this.isQX="undefined"!=typeof $task,this.isLoon="undefined"!=typeof $loon,this.isSurge="undefined"!=typeof $httpClient&&!this.isLoon,this.isNode="function"==typeof require,this.isJSBox=this.isNode&&"undefined"!=typeof $jsbox,this.node=(()=>{if(this.isNode){const s="undefined"!=typeof $request?void 0:require("request"),e=require("fs");return{request:s,fs:e}}return null})(),this.initCache();const t=(s,e)=>new Promise(function(t){setTimeout(t.bind(null,e),s)});Promise.prototype.delay=function(s){return this.then(function(e){return t(s,e)})}}get(s){return this.isQX?("string"==typeof s&&(s={url:s,method:"GET"}),$task.fetch(s)):new Promise((e,t)=>{this.isLoon||this.isSurge?$httpClient.get(s,(s,i,o)=>{s?t(s):e({status:i.status,headers:i.headers,body:o})}):this.node.request(s,(s,i,o)=>{s?t(s):e({...i,status:i.statusCode,body:o})})})}post(s){return this.isQX?("string"==typeof s&&(s={url:s}),s.method="POST",$task.fetch(s)):new Promise((e,t)=>{this.isLoon||this.isSurge?$httpClient.post(s,(s,i,o)=>{s?t(s):e({status:i.status,headers:i.headers,body:o})}):this.node.request.post(s,(s,i,o)=>{s?t(s):e({...i,status:i.statusCode,body:o})})})}initCache(){if(this.isQX&&(this.cache=JSON.parse($prefs.valueForKey(this.name)||"{}")),(this.isLoon||this.isSurge)&&(this.cache=JSON.parse($persistentStore.read(this.name)||"{}")),this.isNode){let s="root.json";this.node.fs.existsSync(s)||this.node.fs.writeFileSync(s,JSON.stringify({}),{flag:"wx"},s=>console.log(s)),this.root={},s=`${this.name}.json`,this.node.fs.existsSync(s)?this.cache=JSON.parse(this.node.fs.readFileSync(`${this.name}.json`)):(this.node.fs.writeFileSync(s,JSON.stringify({}),{flag:"wx"},s=>console.log(s)),this.cache={})}}persistCache(){const s=JSON.stringify(this.cache);this.isQX&&$prefs.setValueForKey(s,this.name),(this.isLoon||this.isSurge)&&$persistentStore.write(s,this.name),this.isNode&&(this.node.fs.writeFileSync(`${this.name}.json`,s,{flag:"w"},s=>console.log(s)),this.node.fs.writeFileSync("root.json",JSON.stringify(this.root),{flag:"w"},s=>console.log(s)))}write(s,e){this.log(`SET ${e}`),-1!==e.indexOf("#")?(e=e.substr(1),this.isSurge&this.isLoon&&$persistentStore.write(s,e),this.isQX&&$prefs.setValueForKey(s,e),this.isNode&&(this.root[e]=s)):this.cache[e]=s,this.persistCache()}read(s){return this.log(`READ ${s}`),-1===s.indexOf("#")?this.cache[s]:(s=s.substr(1),this.isSurge&this.isLoon?$persistentStore.read(s):this.isQX?$prefs.valueForKey(s):this.isNode?this.root[s]:void 0)}delete(s){this.log(`DELETE ${s}`),delete this.cache[s],-1!==s.indexOf("#")?(s=s.substr(1),this.isSurge&this.isLoon&&$persistentStore.write(null,s),this.isQX&&$prefs.setValueForKey(null,s),this.isNode&&delete this.root[s]):this.cache[s]=data,this.persistCache()}notify(e=s,t="",i="",o,n){const h=i+(null==o?"":`\n\nè·³è½¬é“¾æ¥ï¼š${o}`)+(null==n?"":`\n\nå¤šåª’ä½“é“¾æ¥ï¼š${n}`),r=i+(null==n?"":`\n\nå¤šåª’ä½“é“¾æ¥ï¼š${n}`);if(this.isQX&&$notify(e,t,i,{"open-url":o,"media-url":n}),this.isSurge&&$notification.post(e,t,h),this.isLoon&&$notification.post(e,t,r,o),this.isNode)if(this.isJSBox){const s=require("push");s.schedule({title:e,body:t?t+"\n"+i:i})}else console.log(`${e}\n${t}\n${h}\n\n`)}log(s){this.debug&&console.log(s)}info(s){console.log(s)}error(s){console.log("ERROR: "+s)}wait(s){return new Promise(e=>setTimeout(e,s))}done(s={}){this.isQX?this.isRequest&&$done(s):this.isLoon||this.isSurge?this.isRequest?$done(s):$done():this.isNode&&!this.isJSBox&&"undefined"!=typeof $context&&($context.headers=s.headers,$context.statusCode=s.statusCode,$context.body=s.body)}}(s,e)}
